---
title: 数据库-事务
categories:
  - 数据库

  - null
tags:
  - 数据库
  - SQL
  - 事务
copyright: true
date: 2022-06-13 16:08:54
permalink:
description:
image:
---

<img src="https://" alt="" style="width:100%" />  

**前言**

把多条语句作为一个整体进行操作的功能，被称为数据库事务。数据库事务可以确保该事务范围内的所有操作都可以全部成

功或者全部失败。如果事务失败，那么效果就和没有执行这些SQL一样，不会对数据库数据有任何改动。

https://blog.csdn.net/qq_42192693/article/details/109963032

<!-- more -->

# ACID

数据库事务具有ACID这4个特性：

A：Atomic，原子性，将所有SQL作为原子工作单元执行，要么全部执行，要么全部不执行；
C：Consistent，一致性，事务完成后，所有数据的状态都是一致的，即A账户只要减去了100，B账户则必定加上了100；
I：Isolation，隔离性，如果有多个事务并发执行，每个事务作出的修改必须与其他事务隔离；
D：Duration，持久性，即事务完成后，对数据库数据的修改被持久化存储。


对于单条SQL语句，数据库系统自动将其作为一个事务执行，这种事务被称为**隐式事务**。

要手动把多条SQL语句作为一个事务执行，使用BEGIN开启一个事务，使用COMMIT提交一个事务，这种事务被称为**显式事务**

# rollback/commit

1. 使用 **begin + transaction_name** 来创建一个事务

2. commit 指提交事务，即尝试将事务内的SQL做出的修改尝试保存。

3. rollback 指回滚，主动让事务失败，事务内的SQL语句不生效

{% codeblock  %}
BEGIN TRANsaction 
     Update student set sage=sage+1 where sno=’0001’
     Select * from student where sno=’0002’

ROLLBACK  TRANsaction

commit transaction
{% endcodeblock %}

# 并发控制

事务是并发控制的基本单位

## 封锁协议

https://blog.csdn.net/weixin_40448140/article/details/115269643

S锁 - 排他锁、写锁 只允许读取事务和修改数据对象

X锁 - 共享锁、读锁 只允许读取数据对象但不能修改数据对象


**第一类封锁协议**
第一类封锁协议指的是在对数据进行修改操作时需要对数据添加X锁.第一类封锁协议相当于把数据的读取和修改看成一个整体,在事务完成之前其他事务都不能对数据进行修改操作.

**第二类封锁协议**
第二类封锁协议是在第一类封锁协议的基础上加入了S锁.在读取数据前需要对数据添加S锁, 当数据读取完成后释放S锁 .如果一个事务读取数据并添加了S锁,另一个事务添加了X锁,那么添加X锁的那个事务必须等待添加了S锁的事务释放S锁后才能对数据进行修改操作.

**第三类封锁协议**
第三类封锁协议是在第一类封锁协议的基础上加入了S锁,在读取数据前需要对数据添加S锁, **当事务结束后释放S锁**.第三类封锁协议同时解决了数据的修改丢失,不可重复读和读脏数据问题.


## 活锁/死锁

<a href="https://sm.ms/image/DzEbiMu4OVh8XWm" target="_blank"><img src="https://s2.loli.net/2022/06/15/DzEbiMu4OVh8XWm.png" ></a>

避免活锁：采用先来先服务的策略；当多个事务请求封锁同一数据对象时，按请求封锁的先后次序对这些事务排队，该数据对象上的锁一旦释放，首先批准申请队列中第一个事务获得锁。

<a href="https://sm.ms/image/3OpRzWXJSKM4YoP" target="_blank"><img src="https://s2.loli.net/2022/06/15/3OpRzWXJSKM4YoP.png" ></a>

解决死锁方法： 预防死锁（一次性封锁法和顺序封锁法）、诊断死锁并解除（超时法和等待图法）。
一次性封锁法：每个事务必须将所要求的数据对象全部上锁后才能执行读写操作，否则释放占用的资源。
顺序封锁法：对所有数据对象规定一个封锁顺序，所有事务均按这个顺序实行封锁。

## 可串行性

**可串行化调度**：多个事务的并发执行是正确的，当且仅当其结果与按某一次序串行地执行这些事务时的结果相同。

可串行性是并发事务正确调度的准则，一个给定的并发调度，当且仅当它是可串行化的，才认为是正确调度。对若干个事务，不同的并发调度策略其最终的执行结果不一定完全相同。但只要它们的调度是可串行化的，则都是正确调度。                                                           

**冲突操作**：是指不同的事务对同一数据的读写操作和写写操作。

一个调度Sc在保证冲突操作的次序不变的情况下，通过交换两个事务不冲突操作的次序得到另一个调度Sc’，如果Sc’是串行的，称调度Sc是**冲突可串行化的调度**。

**冲突可串行化调度是可串行化调度的充分条件**，不是必要条件。还有不满足冲突可串行化条件的可串行化调度。

## 两段锁协议

数据库管理系统普遍采用两段锁协议的方法实现并发调度的可串行性，从而保证调度的正确性

两段封锁协议（也称两相上锁协议，简写2PL）指所有事务必须分两个阶段对数据项加锁和解锁。

（1）在对任何数据进行读、写操作之前，事务首先要申请并获得对该数据的封锁（读时S锁，写时X锁）；

（2）在释放一个封锁之后，事务不再申请和获得新的封锁。

 “两段”锁的含义是事务分为两个阶段

第一阶段是获得封锁，也称为扩展阶段事务可以申请获得任何数据项上的任何类型的锁，但是不能释放任何锁
第二阶段是释放封锁，也称为收缩阶段事务可以释放任何数据项上的任何类型的锁，但是不能再申请任何锁
若所有事务都遵守两段封锁协议，则对这些事务的任何并发调度策略都是可串行化的。

## 粒度

封锁的粒度：封锁对象的大小。可以是数据库、表、记录、字段等。

封锁粒度与系统的并发度和并发控制的开销密切相关。封锁的粒度越大，数据库所能够封锁的数据单元就越少，并发度就越小，系统开销也越小；封锁的粒度越小，并发度较高，但系统开销也就越大。

# 数据库恢复


计算机硬件故障
软件的错误
操作员的失误
恶意的破坏
故障的影响
运行事务非正常中断，影响数据库中数据的正确性
破坏数据库；全部或部分丢失数据

## 数据库的恢复

数据库管理系统必须具有把数据库从错误状态恢复到某一已知的正确状态（亦称为一致状态或完整状态）的功能，这就是数据库的恢复管理系统对故障的对策

恢复子系统是数据库管理系统的一个重要组成部分
恢复技术是衡量系统优劣的重要指标

## 故障的种类

1. 事务内部的故障

有的是可以通过事务程序本身发现的（转账事务的例子）。有的是非预期的，不能由事务程序处理的。（如运算溢出、并发事务发生死锁而被选中撤销该事务、违反了某些完整性限制等）

2. 系统故障

称为软故障，是指造成系统停止运转的任何事件，使得系统要重新启动。如：整个系统的正常运行突然被破坏、所有正在运行的事务都非正常终止、不破坏数据库、内存中数据库缓冲区的信息全部丢失。常见原因：特定类型的硬件错误（如CPU故障）、操作系统故障、DBMS代码错误、系统断电等。

3. 介质故障

称为硬故障，指外存故障，如：磁盘损坏、磁头碰撞、操作系统的某种潜在错误、瞬时强磁场干扰。介质故障破坏数据库或部分数据库，并影响正在存取这部分数据的所有事务。

介质故障比前两类故障的可能性小得多，但破坏性大得多。

4. 计算机病毒

一种人为的故障或破坏，是一些恶作剧者研制的一种计算机程序。可以繁殖和传播，造成对计算机系统包括数据库的危害。

## 恢复的实现技术

恢复操作的基本原理：冗余

利用存储这系统其他地方的冗余数据来重建数据库中已被破坏或不正确的那部分数据

恢复的实现技术：复杂

一个大型数据库产品，恢复子系统的代码要占全部代码的10%以上

恢复机制涉及的关键问题

如何建立冗余数据（恢复方式）

数据转储（backup）转储是指DBA将整个数据库复制到磁带或另一个磁盘上保存起来的过程

备用的数据文本称为后备副本或后援副本

**登录日志文件（logging）日志文件（log）是用来记录事务对数据库的更新操作的文件**

如何利用这些冗余数据实施数据库恢复

## 恢复策略
1. 事务故障：事务在运行至正常终止点前被终止。

恢复策略：由恢复子系统利用日志文件撤消（ UNDO ）此事务已对数据库进行的修改，使得该事务像根本没有启 动过一样。

事务故障的恢复由系统自动完成，对用户是透明的，不需要用户干预

2. 系统故障 造成数据库不一致状态的原因：

①未完成事务对数据库的更新已写入数据库

②已提交事务对数据库的更新还留 在 缓冲区没来得及写入数据库。

恢复策略：

①Undo 故障发生时未完成的事务

②Redo 已完成的事务 系统故障的恢复由系统在 重新启动时 自动完成，不需要用户干预

3. 介质故障: 称为硬故障，指外存故障，如：磁盘损坏、磁头碰撞、操作系统的某种潜在错误、瞬时强磁场干扰。

恢复策略：

①重装数据库

②重做已完成的事务

介质故障的恢复需要 DBA 介入，DBA 的工作

①重装最近转储的数据库副本和有关的各日志文件副本

②执行系统 提供的恢复命令。具体的恢复操作仍由 DBMS 完成。


<hr />
版权信息